@model FirstWebApplication.Models.ViewModel.RegistrarViewModel
@using System.Linq
@using System.Text.Json

@{
    ViewData["Title"] = "Rapporter";
}

<h1 class="display-6">Rapporter</h1>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@if (Model == null || Model.Obstacles == null || !Model.Obstacles.Any())
{
    <div class="alert alert-info">
        <p>Ingen hindringer funnet.</p>
    </div>
}
else
{
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Navn</th>
                <th>Beskrivelse</th>
                <th>Koordinater</th>
                <th>Høyde (m)</th>
                <th class="text-end">Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var obstacle in Model.Obstacles)
            {
                // Extract coordinates from GeometryGeoJson
                string coordinatesDisplay = "N/A";
                try
                {
                    if (!string.IsNullOrEmpty(obstacle.GeometryGeoJson))
                    {
                        var geoJson = JsonSerializer.Deserialize<JsonElement>(obstacle.GeometryGeoJson);
                        double? lat = null;
                        double? lng = null;

                        if (geoJson.TryGetProperty("geometry", out var geometry))
                        {
                            if (geometry.TryGetProperty("coordinates", out var coords))
                            {
                                if (coords.ValueKind == JsonValueKind.Array && coords.GetArrayLength() >= 2)
                                {
                                    var coordArray = coords.EnumerateArray().ToArray();
                                    lng = coordArray[0].GetDouble();
                                    lat = coordArray[1].GetDouble();
                                }
                            }
                        }
                        else if (geoJson.TryGetProperty("coordinates", out var directCoords))
                        {
                            if (directCoords.ValueKind == JsonValueKind.Array && directCoords.GetArrayLength() >= 2)
                            {
                                var coordArray = directCoords.EnumerateArray().ToArray();
                                lng = coordArray[0].GetDouble();
                                lat = coordArray[1].GetDouble();
                            }
                        }

                        if (lat.HasValue && lng.HasValue)
                        {
                            coordinatesDisplay = $"{lat.Value:F6}, {lng.Value:F6}";
                        }
                    }
                }
                catch
                {
                    coordinatesDisplay = "N/A";
                }

                var statusText = obstacle.ObstacleStatus switch
                {
                    1 => "Pending",
                    2 => "Approved",
                    3 => "Rejected",
                    _ => "Ukjent"
                };
                var statusBadge = obstacle.ObstacleStatus == 1 ? "bg-warning" : obstacle.ObstacleStatus == 2 ? "bg-success" : "bg-danger";

                <tr>
                    <td>@obstacle.ObstacleName</td>
                    <td>@obstacle.ObstacleDescription</td>
                    <td>@coordinatesDisplay</td>
                    <td>@obstacle.ObstacleHeight</td>
                    <td class="text-end">
                        <div class="d-flex align-items-center justify-content-end gap-2">
                            <span class="badge @statusBadge">@statusText</span>
                            <a asp-controller="Registrar" asp-action="DetaljerOmRapport" asp-route-obstacleId="@obstacle.ObstacleId" class="btn btn-sm btn-outline-primary">
                                Se detaljer
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

