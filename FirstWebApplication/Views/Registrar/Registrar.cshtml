@model FirstWebApplication.Models.ViewModel.RegistrarViewModel
@using System.Linq
@using System.Text.Json

@{
    ViewData["Title"] = "Rapporter";
}

<link rel="stylesheet" href="~/css/Registrar.css" />

<div class="registrar-page">
    <h1 class="registrar-title">Rapporter</h1>

    @if (TempData["Success"] != null)
    {
        <div class="registrar-alert registrar-alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="registrar-alert registrar-alert-danger">@TempData["Error"]</div>
    }

    @if (Model == null || Model.Obstacles == null || !Model.Obstacles.Any())
    {
        <div class="registrar-alert registrar-alert-info">
            <p>Ingen hindringer funnet.</p>
        </div>
    }
    else
    {
        <table class="registrar-table">
        <thead>
            <tr>
                <th>Navn</th>
                <th>Registrert av</th>
                <th>Beskrivelse</th>
                <th>Koordinater</th>
                <th>Høyde (m)</th>
                <th class="text-end">Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var obstacle in Model.Obstacles)
            {
                // Extract coordinates from GeometryGeoJson
                string coordinatesDisplay = "N/A";
                try
                {
                    if (!string.IsNullOrEmpty(obstacle.GeometryGeoJson))
                    {
                        var geoJson = JsonSerializer.Deserialize<JsonElement>(obstacle.GeometryGeoJson);
                        double? lat = null;
                        double? lng = null;

                        if (geoJson.TryGetProperty("geometry", out var geometry))
                        {
                            if (geometry.TryGetProperty("coordinates", out var coords))
                            {
                                if (coords.ValueKind == JsonValueKind.Array && coords.GetArrayLength() >= 2)
                                {
                                    var coordArray = coords.EnumerateArray().ToArray();
                                    lng = coordArray[0].GetDouble();
                                    lat = coordArray[1].GetDouble();
                                }
                            }
                        }
                        else if (geoJson.TryGetProperty("coordinates", out var directCoords))
                        {
                            if (directCoords.ValueKind == JsonValueKind.Array && directCoords.GetArrayLength() >= 2)
                            {
                                var coordArray = directCoords.EnumerateArray().ToArray();
                                lng = coordArray[0].GetDouble();
                                lat = coordArray[1].GetDouble();
                            }
                        }

                        if (lat.HasValue && lng.HasValue)
                        {
                            coordinatesDisplay = $"{lat.Value:F6}, {lng.Value:F6}";
                        }
                    }
                }
                catch
                {
                    coordinatesDisplay = "N/A";
                }

                var statusText = obstacle.ObstacleStatus switch
                {
                    1 => "Under behandling",
                    2 => "Godkjent",
                    3 => "Avslått",
                    _ => "Ukjent"
                };
                var statusClass = obstacle.ObstacleStatus == 1 ? "registrar-status-warning" : obstacle.ObstacleStatus == 2 ? "registrar-status-success" : "registrar-status-danger";

                <tr>
                    <td>@obstacle.ObstacleName</td>
                    <td>@(obstacle.OwnerUser?.UserName ?? obstacle.OwnerUser?.Email ?? "Ukjent bruker")</td>
                    <td>@obstacle.ObstacleDescription</td>
                    <td>@coordinatesDisplay</td>
                    <td>@obstacle.ObstacleHeight</td>
                    <td class="registrar-text-end">
                        <div class="registrar-actions">
                            <span class="registrar-status-badge @statusClass">@statusText</span>
                            <a asp-controller="Registrar" asp-action="DetaljerOmRapport" asp-route-obstacleId="@obstacle.ObstacleId" class="registrar-button">
                                Se detaljer
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    }
</div>

