@model FirstWebApplication.Models.ObstacleData
@using System.Text.Json

<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kart</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <link rel="stylesheet" href="~/css/Map.css">
    <style>
        .location-button-container {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1100;
            width: min(420px, calc(100% - 40px));
        }

  /*       .location-button-container #use-current-location {
            background-color: #ff6b00 !important;
            background-image: linear-gradient(145deg, #ff7a00, #ff4d00) !important;
            color: #fff !important;
            border: none !important;
            padding: 18px 32px !important;
            font-size: 18px !important;
            font-weight: 700 !important;
            letter-spacing: 0.5px !important;
            text-transform: uppercase !important;
            border-radius: 999px !important;
            box-shadow: 0 10px 24px rgba(255, 107, 0, 0.4) !important;
            width: 100% !important;
        } */

        .map-wrapper {
            display: flex;
            gap: 15px;
            width: 100%;
            height: 80vh;
        }

        .map-wrapper .map-container {
            flex: 1;
            min-width: 0;
        }

        .draw-buttons-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 160px;
            height: fit-content;
        }
        
        .draw-button {
            display: block;
            width: 100%;
            padding: 16px 24px;
            background-color: #a8d5ba;
            border: 2px solid #95c9a8;
            color: #212529;
            font-size: 16px;
            font-weight: 700;
            line-height: 1.5;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        
        .draw-button:hover {
            background-color: #95c9a8;
            border-color: #82b896;
            color: #212529;
        }
        
        .draw-button.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
            font-weight: 700;
        }
        
        /* Override external CSS for use-current-location button */
        #use-current-location.draw-button {
            background-color: #a8d5ba !important;
            background-image: none !important;
            color: #212529 !important;
            border: 2px solid #95c9a8 !important;
            padding: 16px 24px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            line-height: 1.5 !important;
            letter-spacing: normal !important;
            text-transform: none !important;
            border-radius: 6px !important;
            box-shadow: none !important;
            width: 100% !important;
        }
        
        #use-current-location.draw-button:hover {
            background-color: #95c9a8 !important;
            background-image: none !important;
            border-color: #82b896 !important;
            color: #212529 !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        #use-current-location.draw-button:active {
            background-color: #95c9a8 !important;
            background-image: none !important;
            color: #212529 !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        @@media (min-width: 768px) and (max-width: 1024px) {
            .map-wrapper {
                flex-direction: column;
            }
            
            .map-wrapper .map-container {
                width: 100%;
            }
            
            .draw-buttons-container {
                flex-direction: row;
                width: 100%;
                min-width: auto;
                justify-content: center;
                gap: 15px;
                padding: 20px;
            }
            
            .draw-button {
                flex: 1;
                max-width: 250px;
                margin: 0;
                padding: 20px 28px;
                font-size: 18px;
                font-weight: 700;
            }
            
            #use-current-location.draw-button {
                padding: 20px 28px !important;
                font-size: 18px !important;
                font-weight: 700 !important;
            }
        }
    </style>

</head>
<body>
    <div class="map-wrapper">
        <div class="map-container">
            <div id="map"></div>

            <!-- Info om rapporterte hindringer -->
            <div class="pending-info-container">
                <div class="legend-item">
                    <span class="pending-marker-example"></span>
                    <span>Rapporter under behandling</span>
                </div>
                <div class="legend-item">
                    <span class="approved-marker-example"></span>
                    <span>Godkjente rapporter</span>
                </div>
            </div>
        </div>

        <!-- Drawing buttons positioned next to the map -->
        <div class="draw-buttons-container">
            <button id="draw-point-btn" class="draw-button" title="Tegn punkt">
                Punkt
            </button>
            <button id="draw-line-btn" class="draw-button" title="Tegn linje">
                Linje
            </button>
            <button id="use-current-location" class="draw-button">
                Nåværende posisjon
            </button>
        </div>
    </div>

    <!-- Hidden field for the GeoJSON data produced from map -->
    <input type="hidden" id="GeometryGeoJsonMap" />
    <input type="hidden" id="GeometryGeoJsonCoordinates" />

    <!-- Plassholder for hindringsskjema -->
    <div id="form-container"></div>

    <!-- Leaflet and dependencies -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- jQuery + validation scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <!-- Leaflet.draw -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>


    <script>
        // Hent rapporterte hindringer (under behandling og godkjent) fra server
        // Create anonymous objects with lowercase property names to match JavaScript conventions
        @{
            var reportedObstaclesList = ViewBag.ReportedObstacles as List<FirstWebApplication.Models.ObstacleData> ?? new List<FirstWebApplication.Models.ObstacleData>();
            var reportedObstaclesJson = JsonSerializer.Serialize(reportedObstaclesList.Select(o => new {
                id = o.ObstacleId,
                name = o.ObstacleName,
                height = o.ObstacleHeight,
                description = o.ObstacleDescription,
                status = o.ObstacleStatus,
                geometryGeoJson = o.GeometryGeoJson
            }));
        }
        let reportedObstacles = @Html.Raw(reportedObstaclesJson);
        // Hold hindringer under behandling separat for konfliktsjekking (filtrer i JavaScript)
        let pendingObstacles = reportedObstacles ? reportedObstacles.filter(function(o) { return o.status === 1; }) : [];

        // Funksjon for å hente statustekst
        function getStatusText(status) {
            switch(status) {
                case 1: return 'Under behandling';
                case 2: return 'Godkjent';
                case 3: return 'Avslått';
                default: return 'Ukjent';
            }
        }

        // Funksjon for å hente statusfarge
        function getStatusColor(status) {
            switch(status) {
                case 1: return '#ff9800'; // Orange for pending
                case 2: return '#4caf50'; // Green for approved
                case 3: return '#f44336'; // Red for rejected
                default: return '#9e9e9e'; // Gray for unknown
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Initialiser kartet
            const map = L.map('map').setView([59.9139, 10.7522], 7);

            // Legg til OSM-flislelag
            const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            osm.addTo(map);

            // Funksjonsgruppe for å lagre tegnede lag
            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Funksjonsgruppe for å lagre rapporterte hindringsmarkører
            const reportedMarkers = new L.FeatureGroup();
            map.addLayer(reportedMarkers);

            // Legg til rapporterte hindringer (under behandling og godkjent) som markører på kartet
            if (reportedObstacles && reportedObstacles.length > 0) {
                reportedObstacles.forEach(function(obstacle) {
                    if (obstacle.geometryGeoJson) {
                        try {
                            var geoJson = typeof obstacle.geometryGeoJson === 'string' 
                                ? JSON.parse(obstacle.geometryGeoJson) 
                                : obstacle.geometryGeoJson;
                            
                            // Trekk ut geometri - håndter både Feature og direkte geometri
                            var geometry = geoJson.geometry || geoJson;
                            if (!geometry || !geometry.coordinates) return;
                            
                            var geometryType = geometry.type;
                            var coordinates = geometry.coordinates;
                            
                            // Hent statusfarge basert på hindringens status
                            var statusColor = getStatusColor(obstacle.status);
                            var statusText = getStatusText(obstacle.status);
                            
                            // Opprett popup-innhold
                            var popupContent = '<strong>' + (obstacle.name || 'Rapportert hindring') + '</strong><br>' +
                                              'Høyde: ' + (obstacle.height || 'N/A') + 'm<br>' +
                                              '<small>Status: <span style="color: ' + statusColor + '; font-weight: bold;">' + statusText + '</span></small>';
                            
                            // Opprett en tilpasset ikon basert på status
                            var customIcon = L.divIcon({
                                className: 'reported-obstacle-marker',
                                html: '<div style="background-color: ' + statusColor + '; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            });
                            
                            // Håndter punktgeometri
                            if (geometryType === "Point" && coordinates.length >= 2) {
                                var lat = coordinates[1];
                                var lng = coordinates[0];
                                
                                // Opprett markør med popup som viser status
                                var marker = L.marker([lat, lng], { icon: customIcon })
                                    .bindPopup(popupContent);
                                
                                reportedMarkers.addLayer(marker);
                            }
                            // Håndter LineString/Polyline-geometri
                            else if (geometryType === "LineString" && Array.isArray(coordinates) && coordinates.length > 0) {
                                // Konverter koordinater fra [lng, lat] til [lat, lng] for Leaflet
                                var latlngs = coordinates.map(function(coord) {
                                    return [coord[1], coord[0]]; // [lat, lng]
                                });
                                
                                // Opprett polyline med statusfarge
                                var polyline = L.polyline(latlngs, {
                                    color: statusColor,
                                    weight: 4,
                                    opacity: 0.8
                                }).bindPopup(popupContent);
                                
                                reportedMarkers.addLayer(polyline);
                                
                                // Legg til markører ved hvert hjørne/punkt på polylinjen
                                latlngs.forEach(function(latlng, index) {
                                    var cornerMarker = L.marker(latlng, { icon: customIcon })
                                        .bindPopup(popupContent + '<br><small>Punkt ' + (index + 1) + ' av ' + latlngs.length + '</small>');
                                    reportedMarkers.addLayer(cornerMarker);
                                });
                            }
                        } catch (err) {
                            console.error("Feil ved parsing av hindring GeoJSON:", err, obstacle);
                        }
                    }
                });
            }

            // Custom drawing buttons - remove default draw control
            let currentDrawHandler = null;
            
            // Function to stop current drawing
            function stopDrawing() {
                if (currentDrawHandler) {
                    map.removeLayer(currentDrawHandler);
                    currentDrawHandler = null;
                }
            }
            
            // Point button handler
            document.getElementById('draw-point-btn').addEventListener('click', function() {
                stopDrawing();
                currentDrawHandler = new L.Draw.Marker(map, {
                    icon: new L.Icon.Default()
                });
                currentDrawHandler.enable();
                
                // Update button states
                document.getElementById('draw-point-btn').classList.add('active');
                document.getElementById('draw-line-btn').classList.remove('active');
            });
            
            // Line button handler
            document.getElementById('draw-line-btn').addEventListener('click', function() {
                stopDrawing();
                currentDrawHandler = new L.Draw.Polyline(map, {
                    allowIntersection: false,
                    shapeOptions: {
                        color: '#ff6b00',
                        weight: 4
                    }
                });
                currentDrawHandler.enable();
                
                // Update button states
                document.getElementById('draw-line-btn').classList.add('active');
                document.getElementById('draw-point-btn').classList.remove('active');
            });

            // Lagre siste tegnede lags GeoJSON
            let lastGeoJsonString = "";
            let currentLocationMarker = null;

            // Funksjon for å oppdatere GeoJSON-inndata fra koordinater
            function updateGeoJsonInputs(lat, lng) {
                const geoJsonData = {
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [lng, lat]
                    },
                    properties: {}
                };
                const coordinatesOnly = [lng, lat];
                lastGeoJsonString = JSON.stringify(geoJsonData);

                // Update hidden inputs
                const geoInput = document.getElementById('GeometryGeoJsonMap');
                const coordsInput = document.getElementById('GeometryGeoJsonCoordinates');

                if (geoInput) geoInput.value = lastGeoJsonString;
                if (coordsInput) coordsInput.value = JSON.stringify(coordinatesOnly);
            }

            // Funksjon for å sjekke om det er en hindring under behandling på samme koordinater
            function checkForPendingObstacle(lat, lng) {
                if (!pendingObstacles || pendingObstacles.length === 0) {
                    return null;
                }

                // Toleranse i grader (omtrent 10 meter)
                const tolerance = 0.0001;

                for (var i = 0; i < pendingObstacles.length; i++) {
                    var obstacle = pendingObstacles[i];
                    if (obstacle.geometryGeoJson) {
                        try {
                            var geoJson = typeof obstacle.geometryGeoJson === 'string' 
                                ? JSON.parse(obstacle.geometryGeoJson) 
                                : obstacle.geometryGeoJson;
                            
                            if (geoJson && geoJson.geometry && geoJson.geometry.type === "Point") {
                                var coords = geoJson.geometry.coordinates;
                                var obstacleLat = coords[1];
                                var obstacleLng = coords[0];
                                
                                // Sjekk om koordinater er innenfor toleranse
                                if (Math.abs(obstacleLat - lat) < tolerance && 
                                    Math.abs(obstacleLng - lng) < tolerance) {
                                    return obstacle;
                                }
                            }
                        } catch (err) {
                            console.error("Feil ved parsing av hindring GeoJSON:", err);
                        }
                    }
                }
                return null;
            }

            // Funksjon for å trekke ut koordinater fra GeoJSON
            function extractCoordinates(geoJsonValue) {
                try {
                    const parsed = typeof geoJsonValue === 'string' ? JSON.parse(geoJsonValue) : geoJsonValue;
                    if (parsed && parsed.geometry) {
                        const coords = parsed.geometry.coordinates;
                        if (parsed.geometry.type === "Point" && coords.length >= 2) {
                            return { lat: coords[1], lng: coords[0] };
                        }
                    }
                } catch (e) {
                    console.error("Feil ved uttrekking av koordinater:", e);
                }
                return null;
            }

            // Funksjon for å lukke hindringsskjemaet
            function closeObstacleForm() {
                // Fjern kun markørene som brukeren har tegnet (ikke markørene fra databasen)
                // drawnItems inneholder kun midlertidige markører, reportedMarkers inneholder markører fra databasen
                if (drawnItems) {
                    drawnItems.clearLayers();
                }
                currentLocationMarker = null;
                
                // Tøm GeoJSON inputs
                const geoJsonInput = document.getElementById("GeometryGeoJsonMap");
                const coordinatesInput = document.getElementById("GeometryGeoJsonCoordinates");
                if (geoJsonInput) {
                    geoJsonInput.value = "";
                }
                if (coordinatesInput) {
                    coordinatesInput.value = "";
                }
                
                // Skjul skjemaet
                const formElem = document.getElementById("obstacle-form");
                if (formElem) {
                    formElem.style.display = "none";
                }
                
                // Tøm form-container
                const formContainer = document.getElementById("form-container");
                if (formContainer) {
                    formContainer.innerHTML = "";
                }
                
                // Skjul overlay hvis den finnes
                const overlay = document.querySelector(".obstacle-form-overlay");
                if (overlay) {
                    overlay.style.display = "none";
                }
                
                // Vis knappen igjen når skjemaet lukkes
                const buttonContainer = document.querySelector('.location-button-container');
                if (buttonContainer) {
                    buttonContainer.style.display = 'block';
                }
            }

        // Funksjon for å åpne hindringsskjemaet (ekstrahert for gjenbruk)
            function openObstacleForm() {
                const geoJsonInput = document.getElementById("GeometryGeoJsonMap");
                const coordinatesInput = document.getElementById("GeometryGeoJsonCoordinates");
                const formContainer = document.getElementById("form-container");

                // Try to get value from hidden input first
                let geoJsonValue = geoJsonInput ? geoJsonInput.value : "";
                let geoJsonCoordinates = coordinatesInput ? coordinatesInput.value : "";

                // If no value in hidden input, try to get from lastGeoJsonString
                if (!geoJsonValue && lastGeoJsonString) {
                    geoJsonValue = lastGeoJsonString;
                    // Try to extract coordinates from lastGeoJsonString
                    try {
                        const parsed = JSON.parse(lastGeoJsonString);
                        if (parsed.geometry && parsed.geometry.coordinates) {
                            geoJsonCoordinates = JSON.stringify(parsed.geometry.coordinates);
                        }
                    } catch (e) {
                        console.error("Error parsing lastGeoJsonString:", e);
                    }
                }

                // If still no value, check if there are any drawn items
                if (!geoJsonValue && drawnItems.getLayers().length > 0) {
                    const lastLayer = drawnItems.getLayers()[drawnItems.getLayers().length - 1];
                    const geoJsonData = lastLayer.toGeoJSON();
                    geoJsonValue = JSON.stringify(geoJsonData);
                    const coordinatesOnly = geoJsonData.geometry.coordinates;
                    geoJsonCoordinates = JSON.stringify(coordinatesOnly);
                    
                    // Update hidden inputs for consistency
                    if (geoJsonInput) geoJsonInput.value = geoJsonValue;
                    if (coordinatesInput) coordinatesInput.value = geoJsonCoordinates;
                }

                if (!geoJsonValue) {
                    alert("Vennligst klikk på kartet for å velge hindringens plassering før registrering.");
                    return;
                }

                // Last inn delskjemaet
                fetch('/Obstacle/DataFormPartial')
                    .then(response => response.text())
                    .then(html => {
                        formContainer.innerHTML = html;

                        const formElem = document.getElementById("obstacle-form");
                        if (formElem) {
                            // Legg til event listener for avbryt-knappen
                            const cancelButton = formElem.querySelector('#cancel-obstacle-button');
                            if (cancelButton) {
                                cancelButton.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    closeObstacleForm();
                                });
                            }
                            // Kopier verdier til skjulte felt i skjemaet
                            const formGeoInput = formElem.querySelector('input[name="GeometryGeoJson"]');
                            const formGeoInputCoordinates = formElem.querySelector('input[name="GeometryGeoCoordinates"]');

                            if (formGeoInput) {
                                formGeoInput.value = geoJsonValue;
                            } else {
                                console.error("Could not find input[name='GeometryGeoJson'] in form");
                            }
                            
                            if (formGeoInputCoordinates) {
                                formGeoInputCoordinates.value = geoJsonCoordinates;
                            } else {
                                console.error("Could not find input[name='GeometryGeoCoordinates'] in form");
                            }

                            // Vis skjemaet
                            formElem.style.display = "block";

                            // Hent de nyeste hindringene under behandling fra server og sjekk for konflikter
                            const coords = extractCoordinates(geoJsonValue);
                            if (coords) {
                                fetch('/Map/GetPendingObstacles')
                                    .then(response => response.json())
                                    .then(latestPendingObstacles => {
                                        // Oppdater den globale pendingObstacles-arrayen med nyeste data
                                        pendingObstacles = latestPendingObstacles;
                                        
                                        // Sjekk for hindring under behandling på denne plasseringen
                                        const existingObstacle = checkForPendingObstacle(coords.lat, coords.lng);
                                        if (existingObstacle) {
                                            // Vis advarsel i skjemaet
                                            const warningDiv = formElem.querySelector('#pending-obstacle-warning');
                                            if (warningDiv) {
                                                warningDiv.style.display = 'block';
                                                const warningText = warningDiv.querySelector('.warning-text');
                                                if (warningText) {
                                                    warningText.textContent = 
                                                        'Det er allerede en ubehandlet rapport i denne koordinaten (' + 
                                                        (existingObstacle.name || 'Rapport under behandling') + 
                                                        '). Du er fortsatt velkommen til å rapportere.';
                                                }
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error("Feil ved henting av hindringer under behandling:", error);
                                        // Fallback til å bruke eksisterende pendingObstacles-array
                                        const existingObstacle = checkForPendingObstacle(coords.lat, coords.lng);
                                        if (existingObstacle) {
                                            const warningDiv = formElem.querySelector('#pending-obstacle-warning');
                                            if (warningDiv) {
                                                warningDiv.style.display = 'block';
                                                const warningText = warningDiv.querySelector('.warning-text');
                                                if (warningText) {
                                                    warningText.textContent = 
                                                        'Det er allerede en ubehandlet rapport i denne koordinaten (' + 
                                                        (existingObstacle.name || 'Rapport under behandling') + 
                                                        '). Du er fortsatt velkommen til å rapportere.';
                                                }
                                            }
                                        }
                                    });
                            }

                            // Reparse for unobtrusive-validering
                            $.validator.unobtrusive.parse(formElem);

                            // Håndter skjemainnsending via AJAX
                            function handleFormSubmit(e) {
                                e.preventDefault();

                                const currentForm = e.target;
                                const formData = new FormData(currentForm);
                                
                                // Sjekk hvilken knapp som ble klikket
                                const submitButton = e.submitter || document.activeElement;
                                let actionUrl = '/Obstacle/SubmitObstacle'; // Standard action
                                
                                if (submitButton && submitButton.type === 'submit') {
                                    // Sjekk om knappen har formaction attributt
                                    if (submitButton.hasAttribute('formaction')) {
                                        actionUrl = submitButton.getAttribute('formaction');
                                    } else if (submitButton.id === 'obstacle-quick-save-button') {
                                        actionUrl = '/Obstacle/QuickSaveObstacle';
                                    }
                                }
                                
                                fetch(actionUrl, {
                                    method: 'POST',
                                    body: formData,
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                })
                                .then(response => {
                                    const contentType = response.headers.get("content-type");
                                    if (contentType && contentType.includes("application/json")) {
                                    // Suksess - JSON-respons med omdirigerings-URL
                                    return response.json();
                                } else {
                                    // Validering feilet - returner HTML
                                        return response.text().then(html => ({ html: html }));
                                    }
                                })
                                .then(data => {
                                    if (data.redirectUrl) {
                                        // Suksess - omdiriger til oversiktsside
                                        window.location.href = data.redirectUrl;
                                    } else if (data.html) {
                                        // Validering feilet - oppdater skjema med feil
                                        formContainer.innerHTML = data.html;
                                        const updatedForm = document.getElementById("obstacle-form");
                                        if (updatedForm) {
                                            // Legg til event listener for avbryt-knappen i oppdatert skjema
                                            const cancelButton = updatedForm.querySelector('#cancel-obstacle-button');
                                            if (cancelButton) {
                                                cancelButton.addEventListener('click', function(e) {
                                                    e.preventDefault();
                                                    closeObstacleForm();
                                                });
                                            }
                                            // Kopier koordinater tilbake til skjemaet
                                            const formGeoInput = updatedForm.querySelector('input[name="GeometryGeoJson"]');
                                            const formGeoInputCoordinates = updatedForm.querySelector('input[name="GeometryGeoCoordinates"]');
                                            const geoJsonInput = document.getElementById("GeometryGeoJsonMap");
                                            const coordinatesInput = document.getElementById("GeometryGeoJsonCoordinates");
                                            
                                            if (formGeoInput && geoJsonInput) {
                                                formGeoInput.value = geoJsonInput.value;
                                            }
                                            if (formGeoInputCoordinates && coordinatesInput) {
                                                formGeoInputCoordinates.value = coordinatesInput.value;
                                            }
                                            
                                            updatedForm.style.display = "block";
                                            
                                            // Sjekk for hindring under behandling igjen når skjemaet er oppdatert
                                            const coords = extractCoordinates(geoJsonInput ? geoJsonInput.value : "");
                                            if (coords) {
                                                // Hent de nyeste hindringene under behandling fra server
                                                fetch('/Map/GetPendingObstacles')
                                                    .then(response => response.json())
                                                    .then(latestPendingObstacles => {
                                                        // Oppdater den globale pendingObstacles-arrayen med nyeste data
                                                        pendingObstacles = latestPendingObstacles;
                                                        
                                                        const existingObstacle = checkForPendingObstacle(coords.lat, coords.lng);
                                                        if (existingObstacle) {
                                                            const warningDiv = updatedForm.querySelector('#pending-obstacle-warning');
                                                            if (warningDiv) {
                                                                warningDiv.style.display = 'block';
                                                                const warningText = warningDiv.querySelector('.warning-text');
                                                                if (warningText) {
                                                                    warningText.textContent = 
                                                                        'Det er allerede en ubehandlet rapport i denne koordinaten (' + 
                                                                        (existingObstacle.name || 'Hindring under behandling') + 
                                                                        '). Du er fortsatt velkommen til å rapportere.';
                                                                }
                                                            }
                                                        }
                                                    })
                                                    .catch(error => {
                                                        console.error("Feil ved henting av hindringer under behandling:", error);
                                                        // Fallback til å bruke eksisterende pendingObstacles-array
                                                        const existingObstacle = checkForPendingObstacle(coords.lat, coords.lng);
                                                        if (existingObstacle) {
                                                            const warningDiv = updatedForm.querySelector('#pending-obstacle-warning');
                                                            if (warningDiv) {
                                                                warningDiv.style.display = 'block';
                                                                const warningText = warningDiv.querySelector('.warning-text');
                                                                if (warningText) {
                                                                    warningText.textContent = 
                                                                        'Det er allerede en ubehandlet rapport i denne koordinaten (' + 
                                                                        (existingObstacle.name || 'Hindring under behandling') + 
                                                                        '). Du er fortsatt velkommen til å rapportere.';
                                                                }
                                                            }
                                                        }
                                                    });
                                            }
                                            
                                            $.validator.unobtrusive.parse(updatedForm);
                                            
                                            // Vedlegg innsendingshåndterer på nytt til det oppdaterte skjemaet
                                            updatedForm.addEventListener("submit", handleFormSubmit);
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error("Error submitting form:", error);
                                    alert("En feil oppstod ved innsending av skjemaet. Vennligst prøv igjen.");
                                });
                            }
                            
                            formElem.addEventListener("submit", handleFormSubmit);
                        } else {
                            console.error("Kunne ikke finne hindringsskjema-element");
                        }
                    })
                    
            }

            // Hendelse når en ny form er tegnet
            map.on(L.Draw.Event.CREATED, function (e) {
                // Stop drawing and reset button states
                if (currentDrawHandler) {
                    currentDrawHandler.disable();
                    currentDrawHandler = null;
                }
                document.getElementById('draw-point-btn').classList.remove('active');
                document.getElementById('draw-line-btn').classList.remove('active');
                
                const layer = e.layer;
                drawnItems.addLayer(layer);

                const geoJsonData = layer.toGeoJSON();
                const coordinatesOnly = geoJsonData.geometry.coordinates;
                lastGeoJsonString = JSON.stringify(geoJsonData);

                // Update hidden inputs
                const geoInput = document.getElementById('GeometryGeoJsonMap');
                const coordsInput = document.getElementById('GeometryGeoJsonCoordinates');

                if (geoInput) geoInput.value = lastGeoJsonString;
                if (coordsInput) coordsInput.value = JSON.stringify(coordinatesOnly);
                
                // Skjul knappen når man tegner med tegneverktøyene
                const buttonContainer = document.querySelector('.location-button-container');
                if (buttonContainer) {
                    buttonContainer.style.display = 'none';
                }
                
                // Åpne hindringsskjemaet automatisk etter at koordinater er satt (samme som bruk-nåværende-posisjon)
                openObstacleForm();
            });

            // Hendelse når bruker klikker "Bruk nåværende posisjon"
            document.getElementById("use-current-location").addEventListener("click", function () {
                if (!navigator.geolocation) {
                    alert("Geolokasjon støttes ikke av nettleseren din.");
                    return;
                }

                const button = this;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = "Henter posisjon...";

                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Fjern alle eksisterende lag først for å unngå konflikter
                        drawnItems.clearLayers();
                        currentLocationMarker = null;

                        // Opprett og legg til markør på nåværende posisjon
                        currentLocationMarker = L.marker([lat, lng]);
                        drawnItems.addLayer(currentLocationMarker);
                        map.setView([lat, lng], 15);

                        // Oppdater GeoJSON-inndata - dette er kritisk for at skjemaet skal fungere
                        updateGeoJsonInputs(lat, lng);
                        
                        // Oppdater også lastGeoJsonString for konsistens
                        const geoJsonData = {
                            type: "Feature",
                            geometry: {
                                type: "Point",
                                coordinates: [lng, lat]
                            },
                            properties: {}
                        };
                        lastGeoJsonString = JSON.stringify(geoJsonData);

                        button.disabled = false;
                        button.textContent = originalText;

                        // Skjul knappen etter at posisjon er hentet
                        const buttonContainer = document.querySelector('.location-button-container');
                        if (buttonContainer) {
                            buttonContainer.style.display = 'none';
                        }

                        // Åpne hindringsskjemaet automatisk etter at posisjon er satt
                        openObstacleForm();
                    },
                    function (error) {
                        let errorMessage = "Kunne ikke hente din posisjon. ";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += "Posisjonstilgang nektet av bruker.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += "Posisjonsinformasjon utilgjengelig.";
                                break;
                            case error.TIMEOUT:
                                errorMessage += "Posisjonsforespørsel utløpt.";
                                break;
                            default:
                                errorMessage += "En ukjent feil oppstod.";
                                break;
                        }
                        alert(errorMessage);
                        button.disabled = false;
                        button.textContent = originalText;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        });
    </script>

</body>
</html>
