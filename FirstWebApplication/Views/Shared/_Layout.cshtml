@using Microsoft.AspNetCore.Identity
@using FirstWebApplication.Models
@using FirstWebApplication.Repositories
@using System.Linq
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IRegistrarRepository RegistrarRepository

@{
    // Determine the home page based on user role
    string homeController = "Home";
    string homeAction = "Index";
    bool isAdmin = false;
    ApplicationUser? currentUser = null;
    int notificationCount = 0;
    bool hasNotifications = false;
    
    if (SignInManager.IsSignedIn(User))
    {
        currentUser = await UserManager.GetUserAsync(User);
        if (currentUser != null)
        {
            isAdmin = await UserManager.IsInRoleAsync(currentUser, "Admin");
            
            if (isAdmin)
            {
                homeController = "Admin";
                homeAction = "Dashboard";
            }
            else if (await UserManager.IsInRoleAsync(currentUser, "Pilot"))
            {
                homeController = "Map";
                homeAction = "Map";
            }
            else if (await UserManager.IsInRoleAsync(currentUser, "Registerfører"))
            {
                homeController = "Registrar";
                homeAction = "Registrar";
            }

            // Check for notifications (comments from admin/registerfører that are not automatic submission comments)
            try
            {
                var allRapports = await RegistrarRepository.GetAllRapports();
                var notifications = allRapports
                    .Where(r => !(r.RapportComment.StartsWith("Hindring '") && 
                                 r.RapportComment.Contains(" ble sendt inn. Høyde:")))
                    .ToList();
                notificationCount = notifications.Count;
                hasNotifications = notificationCount > 0;
            }
            catch
            {
                // If there's an error, just set to 0
                notificationCount = 0;
                hasNotifications = false;
            }
        }
    }
}

<html lang="en">
<head>
    <link rel="icon" type="image/png" href="~/kartverket-logo.png" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Kartverket</title>
    @await Html.PartialAsync("_Styles")  <!-- Include CSS -->
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container-fluid d-flex justify-content-between align-items-center">
                <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">Kartverket</a>
                
                <div class="dropdown" style="position: relative;">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Meny
                        @if (hasNotifications)
                        {
                            <span class="notification-indicator has-notifications">@(notificationCount > 9 ? "9+" : notificationCount.ToString())</span>
                        }
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" asp-area="" asp-controller="Map" asp-action="Map">Map</a></li>
                        <li><a class="dropdown-item" asp-area="" asp-controller="Registrar" asp-action="Registrar">Registerfører</a></li>
                        <li><a class="dropdown-item varsling-menu-item @(hasNotifications ? "has-notifications" : "")" 
                               asp-area="" asp-controller="Varsling" asp-action="Index" 
                               id="varslingMenuItem">
                               Varsling
                               @if (hasNotifications)
                               {
                                   <span class="badge bg-primary ms-2">@notificationCount</span>
                               }
                           </a></li>
                        <li><a class="dropdown-item" asp-area="" asp-controller="Advice" asp-action="FeedbackForm">Feedback</a></li>
                        @if (isAdmin)
                        {
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" asp-controller="Admin" asp-action="Dashboard">Admin</a></li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - Kartverket - <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    @await Html.PartialAsync("_Scripts")  <!-- Include JS -->
    @RenderSection("Scripts", required: false)  <!-- Optional page-specific scripts -->
    
    <script>
        // Check for notifications periodically and update UI
        (function() {
            var hasInitialNotifications = @(hasNotifications ? "true" : "false");
            var notificationCount = @notificationCount;
            
            function updateNotificationUI(count) {
                var hasNotifications = count > 0;
                var indicator = document.querySelector('.notification-indicator');
                var varslingMenuItem = document.getElementById('varslingMenuItem');
                var menuButton = document.getElementById('navbarDropdown');
                
                // Update indicator on menu button
                if (indicator) {
                    if (hasNotifications) {
                        indicator.classList.add('has-notifications');
                        indicator.textContent = count > 9 ? '9+' : count.toString();
                    } else {
                        indicator.classList.remove('has-notifications');
                    }
                } else if (hasNotifications && menuButton) {
                    // Create indicator if it doesn't exist
                    var newIndicator = document.createElement('span');
                    newIndicator.className = 'notification-indicator has-notifications';
                    newIndicator.textContent = count > 9 ? '9+' : count.toString();
                    menuButton.appendChild(newIndicator);
                }
                
                // Update varsling menu item
                if (varslingMenuItem) {
                    if (hasNotifications) {
                        varslingMenuItem.classList.add('has-notifications');
                        // Update or create badge
                        var badge = varslingMenuItem.querySelector('.badge');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'badge bg-primary ms-2';
                            varslingMenuItem.appendChild(badge);
                        }
                        badge.textContent = count > 9 ? '9+' : count.toString();
                    } else {
                        varslingMenuItem.classList.remove('has-notifications');
                        var badge = varslingMenuItem.querySelector('.badge');
                        if (badge) {
                            badge.remove();
                        }
                    }
                }
            }
            
            // Check for notifications every 30 seconds
            if (@(SignInManager.IsSignedIn(User) ? "true" : "false")) {
                setInterval(function() {
                    fetch('@Url.Action("GetNotificationCount", "Varsling")')
                        .then(response => response.json())
                        .then(data => {
                            if (data.count !== notificationCount) {
                                notificationCount = data.count;
                                updateNotificationUI(notificationCount);
                            }
                        })
                        .catch(error => {
                            console.error('Error checking notifications:', error);
                        });
                }, 30000); // Check every 30 seconds
            }
            
            // Highlight varsling menu item when dropdown is opened and there are notifications
            var dropdown = document.getElementById('navbarDropdown');
            if (dropdown) {
                dropdown.addEventListener('click', function() {
                    if (hasInitialNotifications || notificationCount > 0) {
                        setTimeout(function() {
                            var varslingItem = document.getElementById('varslingMenuItem');
                            if (varslingItem) {
                                varslingItem.style.fontWeight = 'bold';
                            }
                        }, 100);
                    }
                });
            }
        })();
    </script>
</body>
</html>
